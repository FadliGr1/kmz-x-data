<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konverter KML/KMZ Otomatis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }

        #app-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 90%;
            border: 1px solid #e0e0e0;
        }

        h1 {
            color: #1c1e21;
            margin-bottom: 10px;
        }

        p {
            color: #606770;
            margin-bottom: 30px;
        }

        #drop-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 50px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #drop-area.highlight {
            background-color: #e9f5ff;
            border-color: #0056b3;
        }

        #file-label {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }

        #file-input {
            display: none;
        }

        #status {
            margin-top: 25px;
            font-style: italic;
            color: #28a745;
            min-height: 24px;
            font-weight: 500;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #007bff;
            animation: spin 1s ease infinite;
            display: none;
            /* Sembunyi secara default */
            margin: 25px auto 0;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="app-container">
        <h1>Konverter KML/KMZ üó∫Ô∏è</h1>
        <p>Unggah file .kml atau .kmz Anda. Alat ini akan memindahkan data gambar dari <strong>ExtendedData</strong> ke
            tag <strong>description</strong> dan mengunduh hasilnya sebagai file .kmz secara otomatis.</p>

        <div id="drop-area">
            <input type="file" id="file-input" accept=".kml,.kmz">
            <label for="file-input" id="file-label">Seret & lepas file di sini, atau klik untuk memilih</label>
        </div>

        <div class="spinner" id="spinner"></div>
        <div id="status">Menunggu file...</div>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        const spinner = document.getElementById('spinner');

        // Mencegah perilaku default browser untuk drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Menambahkan highlight saat file diseret di atas area
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        // Menangani file yang dijatuhkan (drop)
        dropArea.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Menangani file yang dipilih dari input
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        /**
         * Fungsi utama untuk memproses file
         * @param {File} file - File yang akan diproses
         */
        async function handleFile(file) {
            if (!file.name.endsWith('.kml') && !file.name.endsWith('.kmz')) {
                statusDiv.textContent = '‚ùå Error: Harap pilih file .kml atau .kmz';
                statusDiv.style.color = 'red';
                return;
            }

            statusDiv.textContent = 'Membaca file...';
            statusDiv.style.color = '#333';
            spinner.style.display = 'block';

            const originalFileName = file.name.split('.').slice(0, -1).join('.');
            const newFileName = `${originalFileName}_converted.kmz`;

            try {
                if (file.name.endsWith('.kml')) {
                    await processKmlFile(file, newFileName);
                } else { // .kmz
                    await processKmzFile(file, newFileName);
                }
            } catch (error) {
                console.error('Terjadi kesalahan:', error);
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.style.color = 'red';
                spinner.style.display = 'none';
            }
        }

        /**
         * Memproses file KML tunggal
         * @param {File} file - File KML
         * @param {string} newFileName - Nama file output
         */
        async function processKmlFile(file, newFileName) {
            statusDiv.textContent = 'Memproses file KML...';
            const kmlText = await file.text();
            const modifiedKmlText = processKmlContent(kmlText);

            statusDiv.textContent = 'Membuat file KMZ...';
            const zip = new JSZip();
            zip.file("doc.kml", modifiedKmlText);

            const content = await zip.generateAsync({ type: "blob" });
            downloadFile(content, newFileName);
        }

        /**
         * Memproses file KMZ (arsip zip)
         * @param {File} file - File KMZ
         * @param {string} newFileName - Nama file output
         */
        async function processKmzFile(file, newFileName) {
            statusDiv.textContent = 'Membuka arsip KMZ...';
            const zip = await JSZip.loadAsync(file);

            // Cari file KML utama di dalam arsip
            let kmlFile = null;
            let kmlFileName = '';
            for (const fileName in zip.files) {
                if (fileName.toLowerCase().endsWith('.kml')) {
                    kmlFile = zip.files[fileName];
                    kmlFileName = fileName;
                    break;
                }
            }

            if (!kmlFile) {
                throw new Error('Tidak ada file .kml yang ditemukan di dalam arsip KMZ.');
            }

            statusDiv.textContent = `Memproses ${kmlFileName}...`;
            const kmlText = await kmlFile.async('string');
            const modifiedKmlText = processKmlContent(kmlText);

            // Buat arsip KMZ baru
            statusDiv.textContent = 'Menyusun ulang file KMZ...';
            const newZip = new JSZip();
            // Tambahkan KML yang sudah dimodifikasi
            newZip.file(kmlFileName, modifiedKmlText);

            // Salin semua file lain (gambar, dll) dari KMZ lama ke yang baru
            for (const fileName in zip.files) {
                if (fileName !== kmlFileName) {
                    newZip.file(fileName, await zip.files[fileName].async('blob'));
                }
            }

            const content = await newZip.generateAsync({ type: "blob" });
            downloadFile(content, newFileName);
        }

        /**
         * Logika inti untuk memodifikasi konten string KML (XML)
         * @param {string} kmlText - Konten KML sebagai teks
         * @returns {string} - Konten KML yang sudah dimodifikasi
         */
        function processKmlContent(kmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, "application/xml");

            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            let modificationsCount = 0;

            for (const placemark of placemarks) {
                const extendedData = placemark.querySelector('ExtendedData');
                if (!extendedData) continue;

                const pictureData = extendedData.querySelector('Data[name="pictures"]');
                if (!pictureData) continue;

                const valueNode = pictureData.querySelector('value');
                if (valueNode && valueNode.textContent) {
                    const cdataContent = valueNode.textContent;
                    // Ekstrak hanya tag <img> dari CDATA
                    const imgMatch = cdataContent.match(/<img[^>]+>/);

                    if (imgMatch) {
                        let imgTag = imgMatch[0];
                        // Tambahkan atribut style="max-width:500px;"
                        if (!imgTag.includes('style=')) {
                            imgTag = imgTag.replace('<img', '<img style="max-width:500px;"');
                        } else {
                            // Jika sudah ada style, tambahkan di dalamnya (lebih aman)
                            imgTag = imgTag.replace(/style="([^"]*)"/, 'style="max-width:500px; $1"');
                        }

                        // Buat atau perbarui tag <description>
                        let descriptionNode = placemark.querySelector('description');
                        if (!descriptionNode) {
                            descriptionNode = xmlDoc.createElement('description');
                            // Letakkan di awal elemen Placemark
                            placemark.insertBefore(descriptionNode, placemark.firstChild);
                        }

                        // Isi dengan CDATA yang berisi tag gambar
                        descriptionNode.textContent = ''; // Hapus konten lama
                        descriptionNode.appendChild(xmlDoc.createCDATASection(imgTag));

                        // Hapus data gambar dari ExtendedData
                        pictureData.parentNode.removeChild(pictureData);
                        modificationsCount++;
                    }
                }
            }

            statusDiv.textContent = `‚úÖ ${modificationsCount} placemark berhasil dimodifikasi.`;
            const serializer = new XMLSerializer();
            return serializer.serializeToString(xmlDoc);
        }

        /**
         * Memicu unduhan file di browser
         * @param {Blob} content - Konten file
         * @param {string} fileName - Nama file untuk diunduh
         */
        function downloadFile(content, fileName) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Membersihkan memori

            spinner.style.display = 'none';
            statusDiv.textContent += ' File siap diunduh!';
            setTimeout(() => {
                statusDiv.textContent = 'Menunggu file...';
                statusDiv.style.color = '#333';
            }, 5000);
        }

    </script>

</body>

</html>